# ワーク: AWS StepFunctions のステートマシンを作成して実行してみよう

## このワーク環境は、ワーク実施時だけの一時的な環境になります。

---

## 手順

1. Amazon States Language (ASL) の編集
   - このリポジトリにある WorkStateMachine.json のコードを使用している PC のテキストエディタに貼り付け
   - `000000000000` を講師の指定する AWS アカウント ID に置き換え
     
2. 講師のガイドにもとづき、AWS マネジメントコンソールにサインインしてください。

3. AWS Step Functions のページを表示してください。

4. 以降の手順を実施して ステートマシンを作成、テストを実行して下さい。

5. ステートマシンの作成
  - [**ステートマシンの作成**] をクリック
  - **テンプレートの選択** で **Blank** を選択し、右下の **[選択]** をクリック
  - ページ左上にある [MyStateMachine-xxxx] の右横の鉛筆アイコンをクリック
  - **ステートマシン名**: `MyStateMachine-00`
    - **00部分をご自分の番号に変更して下さい。**
  - **アクセス許可** セクション
    - **実行ロール** で **StepFunctionsWork-role** を選択
  - ページ上部にある **[{} コード]** をクリック
  - 
  - ページ左側のコード入力部分を、最初の手順で用意した ASL に置き換える 
  - ページ右上にある [**作成**] をクリック
    
5. ステートマシンの実行
  - [**実行**] をクリック
  - **実行を開始** ウィンドウで、**入力** に下記を入力して [**実行を開始**] をクリック
    - ```
      {
          "Loan": {
              "accountNumber": "12345678",
              "amount": "1000000"
          }
      }
      ``` 
  - **グラフビュー** でステートマシンの実行状況を確認
  - **グラフビュー** すべてのステートが緑色で表示されていることを確認
  - ページ上部の [**新しい実行**] をクリックして 繰り返し 3 ～ 4 回実行
    - ステートマシンのフローが異なる場合があることを確認
    - (Load-Screening の結果がランダムになるように Lambda 関数を実装しています。)
    
6. ステートマシンの定義や実行結果の確認
   - ステートマシンの実行結果のページを表示
   - **グラフビュー** で **Loan-Screening** ステートをクリック
   - 右側で **定義** タブ をクリック
     - **Type** や **Resource**、**Parameters** の内容を確認
     - **Next** の内容を確認
     - **ResultPath** の内容を確認
       - これはこのステートで実行された Lambda 関数の結果を追加する JSON パスを指定しています。
   - **入力/出力** タブをクリック
   - **状態の入力** を確認
     - ステートマシン実行時に入力したパラメータが表示されていることを確認
   - **状態の出力** を確認
     - ステートマシン実行時に入力したパラメータも出力結果に含まれていることを確認
     - Result 要素に Lambda の実行結果である `"statusCode": 200` や `"body": "Failed"` が存在することを確認
   - **グラフビュー** で **Choice** ステートをクリック
     - 右側で **定義** タブ をクリック
       - **Type** の内容を確認
       - **Choice** や **Default** の内容を確認
         - ここでは、`"Variable": "$.Result.Payload.body"` の値が `Passed` の場合 `Parallel` ステートに分岐し、それ以外の場合は `Other-Loan-Recommendations` ステートに進むことが定義されています。
       - **OutputPath** の内容を確認
         - ここでは、このステートの出力結果を、"$.Loan" だけに限定することを指定しています。（デフォルトでは入力値がすべて出力値になります。） 
     - **入力/出力** タブをクリック
     - **状態の入力** を確認
       - **Loan-Screening** ステートの出力が表示されていることを確認
     - **状態の出力** を確認
       - ステートマシン実行時に入力したパラメータのうち、Loan 要素以下の値（下記）が表示されていることを確認
       - ```
         {
             "accountNumber": "12345678",
             "amount": "1000000"
         }
         ```
   - **グラフビュー** で **Choice** の次のステートをクリック
     - - **状態の入力** タブをクリック
       - **Choice** ステートの出力が表示されていることを確認
   - 実行結果のページで **Event view** や **State view** を切り替えて内容を確認
#### 参考
* 時間があれば、下記の外部記事(DeveloperIO produced by Classmethod)もご参照ください。
  - [[アップデート] AWS Step Functions で変数が使えるようになりました](https://dev.classmethod.jp/articles/step-functions-variables/)
---

* WorkStateMachine.json
  - ステートマシンのコード (Amazon State Language)
* sfn-Loan
  - ステートマシンから呼び出す Lambda 関数の AWS SAM リソース






